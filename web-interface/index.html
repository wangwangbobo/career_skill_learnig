<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职途助手AI求职大师 - 专业求职学习助手</title>
    
    <!-- 优先加载关键CSS，避免白屏 -->  
    <link rel="stylesheet" href="styles.css">
    
    <!-- 内联关键样式，立即显示内容 -->
    <style>
        /* 立即显示页面，避免白屏 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            opacity: 1 !important; /* 强制显示 */
        }
        
        /* 加载指示器的简单样式 */
        .simple-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            font-weight: 600;
            z-index: 9999;
        }
        
        .simple-loading.hidden {
            display: none;
        }
        
        /* 简单的旋转动画 */
        .simple-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    
    <!-- 异步加载外部字体，设置超时降级 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <script>
        // 字体加载超时处理
        (function() {
            let fontLoaded = false;
            let iconLoaded = false;
            
            // 设置2秒超时
            setTimeout(() => {
                if (!fontLoaded) {
                    console.warn('⏰ Google Fonts 加载超时，使用系统字体');
                    document.body.classList.add('font-fallback');
                }
                if (!iconLoaded) {
                    console.warn('⏰ FontAwesome 加载超时，使用文本图标');
                    document.body.classList.add('icon-fallback');
                }
            }, 2000);
            
            // 动态加载字体
            const fontLink = document.createElement('link');
            fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap';
            fontLink.rel = 'stylesheet';
            fontLink.onload = () => { fontLoaded = true; console.log('✅ Google Fonts 加载完成'); };
            fontLink.onerror = () => { console.warn('❌ Google Fonts 加载失败'); };
            document.head.appendChild(fontLink);
            
            // 动态加载图标
            const iconLink = document.createElement('link');
            iconLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
            iconLink.rel = 'stylesheet';
            iconLink.onload = () => { iconLoaded = true; console.log('✅ FontAwesome 加载完成'); };
            iconLink.onerror = () => { console.warn('❌ FontAwesome 加载失败'); };
            document.head.appendChild(iconLink);
        })();
    </script>
    
    <!-- 思维导图Markmap库和样式 -->
    <script>
        // 动态加载Markmap相关库
        window.markmapLibsLoading = true;
        window.markmapLibsLoadFailed = false;
        window.markmapLibsLoaded = false;
        
        // 创建script标签加载D3和Markmap
        function loadMarkmapLibs() {
            console.log('🧠 开始加载Markmap库...');
            
            // 直接加载markmap-autoloader，它会自动处理依赖
            const autoLoaderScript = document.createElement('script');
            autoLoaderScript.src = 'https://cdn.jsdelivr.net/npm/markmap-autoloader@0.14.3';
            autoLoaderScript.onload = () => {
                console.log('✅ Markmap autoloader加载完成');
                window.markmapLibsLoaded = true;
                window.markmapLibsLoading = false;
                
                // 等待autoloader初始化
                setTimeout(() => {
                    if (window.markmap) {
                        console.log('✅ Markmap库初始化完成');
                    }
                }, 500);
            };
            autoLoaderScript.onerror = () => {
                console.warn('❌ Markmap autoloader加载失败，尝试备用方案');
                loadMarkmapFallback();
            };
            document.head.appendChild(autoLoaderScript);
        }
        
        // 备用加载方案
        function loadMarkmapFallback() {
            console.log('🔄 使用备用加载方案...');
            
            // 加载D3
            const d3Script = document.createElement('script');
            d3Script.src = 'https://cdn.jsdelivr.net/npm/d3@7';
            d3Script.onload = () => {
                console.log('✅ D3库加载完成');
                
                // D3加载完成后加载Markmap
                const markmapScript = document.createElement('script');
                markmapScript.src = 'https://cdn.jsdelivr.net/npm/markmap-view@0.14.3';
                markmapScript.onload = () => {
                    console.log('✅ Markmap库加载完成');
                    window.markmapLibsLoaded = true;
                    window.markmapLibsLoading = false;
                    
                    // 加载Markmap工具栏
                    const toolbarScript = document.createElement('script');
                    toolbarScript.src = 'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3';
                    toolbarScript.onload = () => console.log('✅ Markmap工具栏加载完成');
                    document.head.appendChild(toolbarScript);
                };
                markmapScript.onerror = () => {
                    console.warn('❌ Markmap库加载失败，使用降级方案');
                    window.markmapLibsLoadFailed = true;
                    window.markmapLibsLoading = false;
                };
                document.head.appendChild(markmapScript);
            };
            d3Script.onerror = () => {
                console.warn('❌ D3库加载失败，使用降级方案');
                window.markmapLibsLoadFailed = true;
                window.markmapLibsLoading = false;
            };
            document.head.appendChild(d3Script);
        }
        
        // 加载Markmap CSS
        function loadMarkmapCSS() {
            const markmapCSS = document.createElement('link');
            markmapCSS.rel = 'stylesheet';
            markmapCSS.href = 'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3/dist/style.css';
            markmapCSS.onload = () => console.log('✅ Markmap CSS加载完成');
            document.head.appendChild(markmapCSS);
        }
        
        // 页面加载完成后尝试加载Markmap库
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadMarkmapLibs();
                loadMarkmapCSS();
            });
        } else {
            loadMarkmapLibs();
            loadMarkmapCSS();
        }
        
        // 3秒超时降级
        setTimeout(() => {
            if (window.markmapLibsLoading && !window.markmapLibsLoaded) {
                console.warn('⏰ Markmap库加载超时，使用降级方案');
                window.markmapLibsLoadFailed = true;
                window.markmapLibsLoading = false;
            }
        }, 3000);
    </script>
    
    <!-- Markmap样式 -->
    <style>
        .markmap-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
        }
        
        .markmap-header {
            padding: 10px 15px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .markmap-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .markmap-controls {
            display: flex;
            gap: 5px;
        }
        
        .markmap-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s ease;
        }
        
        .markmap-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .markmap-content {
            width: 100%;
            height: calc(100% - 45px);
            position: relative;
        }
        
        .markmap-content svg {
            width: 100%;
            height: 100%;
        }
        
        /* 思维导图节点样式 */
        .markmap g[data-depth="0"] > circle {
            fill: #4f46e5 !important;
        }
        
        .markmap g[data-depth="1"] > circle {
            fill: #059669 !important;
        }
        
        .markmap g[data-depth="2"] > circle {
            fill: #dc2626 !important;
        }
        
        .markmap g[data-depth="3"] > circle {
            fill: #d97706 !important;
        }
        
        /* 降级树形结构样式 */
        .markmap-tree-fallback {
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .mindmap-tree-level-0 {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .mindmap-node-item {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .mindmap-node-text {
            font-weight: 500;
        }
    </style>
    
    <!-- 思维导图使用本地降级方案，不依赖外部CDN -->
    <script>
        // 设置思维导图使用降级模式
        window.markmapLibsLoading = false;
        window.markmapLibsLoadFailed = true;
        window.markmapLibsLoaded = false;
        
        console.log('🧠 思维导图使用本地降级方案，不加载外部CDN库');
    </script>
    
    <!-- 快速初始化脚本 - 性能优化 -->
    <script>
        // 页面快速显示逻辑 - DOM准备就绪后立即显示
        function quickShowPage() {
            console.log('⚡ 快速显示页面...');
            
            const simpleLoading = document.getElementById('simpleLoading');
            if (simpleLoading) {
                simpleLoading.classList.add('hidden');
                console.log('✅ 加载指示器已隐藏');
            }
            
            // 确保页面内容可见
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';
            
            console.log('🚀 页面已快速显示，不等待外部资源');
        }
        
        // DOM内容加载完成后立即显示页面
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', quickShowPage);
        } else {
            quickShowPage();
        }
        
        // 备用方案：500ms后强制显示页面
        setTimeout(quickShowPage, 500);
    </script>
    
    <script src="fast-init.js"></script>
    <!-- 降级CSS：当外部资源加载失败时的备用样式 -->
    <style>
        /* 字体降级：如果Inter字体没加载成功，使用系统字体 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        
        /* 图标降级：如果FontAwesome没加载成功，显示文本 */
        .icon-fallback {
            display: none;
        }
        
        /* 字体降级样式 */
        .font-fallback {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif !important;
        }
        
        /* 图标降级样式 */
        .icon-fallback .fas {
            font-family: Arial, sans-serif !important;
        }
        .icon-fallback .fas.fa-graduation-cap:before { content: "🎓"; }
        .icon-fallback .fas.fa-cog:before { content: "⚙️"; }
        .icon-fallback .fas.fa-briefcase:before { content: "💼"; }
        .icon-fallback .fas.fa-file-alt:before { content: "📄"; }
        .icon-fallback .fas.fa-lightbulb:before { content: "💡"; }
        .icon-fallback .fas.fa-question-circle:before { content: "❓"; }
        .icon-fallback .fas.fa-book:before { content: "📚"; }
        .icon-fallback .fas.fa-certificate:before { content: "🏆"; }
        .icon-fallback .fas:not([class*="fa-"]):before {
            content: "📋";
            font-family: Arial, sans-serif;
        }
        
        /* 加载指示器 */
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            color: #4f46e5;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .loading-indicator.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 简单加载指示器 -->
    <div class="simple-loading" id="simpleLoading">
        <div class="simple-spinner"></div>
        正在加载职途助手...
    </div>

    <!-- 顶部导航 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>职途助手</span>
            </div>
            <div class="nav-menu">
                <a href="#home" class="nav-link active">首页</a>
                <a href="#features" class="nav-link">功能</a>
                <a href="#about" class="nav-link">关于</a>
                <button class="config-btn" id="configBtn">
                    <i class="fas fa-cog"></i>
                    <span>配置API</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧内容区域 -->
        <div class="content-area">
            <!-- 欢迎区域 -->
            <section class="hero-section" id="home">
                <div class="hero-content">
                    <div class="robot-avatar">
                        🤖
                    </div>
                    <h1 class="hero-title">职途助手</h1>
                    <h2 class="hero-subtitle">Hi 同学！</h2>
                    <p class="hero-description">根据职位描述为你制定专属学习路线，提供从岗位分析到面试准备的全方位支持，轻松拿下offer~</p>
                </div>
            </section>

            <!-- 职位输入区域 -->
            <section class="job-input-section">
                <div class="input-card">
                    <div class="input-tabs">
                        <button class="tab-btn active" id="jobNameTab" data-tab="jobName">
                            <i class="fas fa-briefcase"></i>
                            输入岗位名称
                        </button>
                        <button class="tab-btn" id="jobDescTab" data-tab="jobDesc">
                            <i class="fas fa-file-alt"></i>
                            上传职位描述
                        </button>
                    </div>
                    
                    <!-- 岗位名称输入 -->
                    <div class="tab-content active" id="jobNameContent">
                        <div class="input-group">
                            <label for="jobTitle">职位名称：</label>
                            <input 
                                type="text" 
                                id="jobTitle" 
                                placeholder="请填写职位信息（如AI工程师）" 
                                class="job-input"
                            >
                        </div>
                        <div class="quick-jobs">
                            <span class="quick-label">热门职位：</span>
                            <button class="job-tag" data-job="前端工程师">前端工程师</button>
                            <button class="job-tag" data-job="后端工程师">后端工程师</button>
                            <button class="job-tag" data-job="AI工程师">AI工程师</button>
                            <button class="job-tag" data-job="产品经理">产品经理</button>
                            <button class="job-tag" data-job="数据分析师">数据分析师</button>
                        </div>
                    </div>
                    
                    <!-- 职位描述上传 -->
                    <div class="tab-content" id="jobDescContent">
                        <div class="input-group">
                            <label for="jobDescription">职位描述：</label>
                            <textarea 
                                id="jobDescription" 
                                placeholder="请填写职位描述信息" 
                                class="job-textarea"
                                rows="6"
                            ></textarea>
                        </div>
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>点击上传职位描述图片或拖拽到此处</p>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            <button class="upload-btn" id="uploadBtn">
                                <i class="fas fa-image"></i>
                                选择图片
                            </button>
                        </div>
                    </div>
                    
                    <button id="generateBtn" class="generate-btn" disabled>
                        <i class="fas fa-book"></i>
                        生成学习路线
                    </button>
                </div>
            </section>

        <!-- 加载状态 -->
        <section class="loading-section" id="loadingSection" style="display: none;">
            <div class="loading-card">
                <div class="loading-content">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                    <h3 class="loading-title">AI正在为您分析职位和生成学习资料...</h3>
                    
                    <!-- 进度条 -->
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">0%</div>
                    <div class="loading-steps">
                        <div class="step active" id="step1">
                            <i class="fas fa-search"></i>
                            <span>分析职位技能</span>
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-lightbulb"></i>
                            <span>生成知识点</span>
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-question-circle"></i>
                            <span>生成面试题</span>
                        </div>
                        <div class="step" id="step4">
                            <i class="fas fa-book"></i>
                            <span>推荐书籍</span>
                        </div>
                        <div class="step" id="step5">
                            <i class="fas fa-certificate"></i>
                            <span>推荐证书</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 结果展示区域 -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h2 class="results-title">
                    <i class="fas fa-graduation-cap"></i>
                    后端工程师 核心知识点
                </h2>
                <div class="results-meta">
                    <span class="topic-display" id="topicDisplay"></span>
                    <span class="generation-time" id="generationTime"></span>
                </div>
                <div class="results-actions">
                    <button class="result-action-btn" id="saveBtn">
                        <i class="fas fa-save"></i>
                        保存
                    </button>
                    <button class="result-action-btn" id="exportBtn">
                        <i class="fas fa-file-pdf"></i>
                        导出PDF
                    </button>
                    <button class="result-action-btn" id="exportFeishuBtn">
                        <i class="fas fa-file-alt"></i>
                        导出飞书文档
                    </button>
                </div>
            </div>

            <!-- 思维导图 -->
            <div class="result-card" id="mindmapCard">
                <div class="card-header">
                    <h3><i class="fas fa-project-diagram"></i> 思维导图</h3>
                    <span class="card-status" id="mindmapStatus">等待中</span>
                    <div class="mindmap-controls">
                        <button class="mindmap-btn" id="expandAll" title="展开全部">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <button class="mindmap-btn" id="collapseAll" title="折叠全部">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </button>
                        <button class="mindmap-btn" id="downloadMindmap" title="下载思维导图">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="card-content" id="mindmapContent">
                    <!-- 思维导图内容将动态加载 -->
                </div>
            </div>

            <!-- 五个独立模块展示区域 -->
            <div class="content-modules-container" id="contentModulesContainer">
                <!-- 知识点模块 -->
                <div class="module-card knowledge" id="knowledgeModule" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-lightbulb"></i>
                        <h3 class="module-title">核心知识点</h3>
                        <span class="module-count" id="knowledgeCount">0</span>
                    </div>
                    <div class="module-content" id="knowledgeContent">
                        <!-- 知识点内容将动态加载 -->
                    </div>
                </div>

                <!-- 高频面试题模块 -->
                <div class="module-card interview" id="interviewModule" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-question-circle"></i>
                        <h3 class="module-title">高频面试题</h3>
                        <span class="module-count" id="interviewCount">0</span>
                    </div>
                    <div class="module-content" id="interviewContent">
                        <!-- 面试题内容将动态加载 -->
                    </div>
                </div>

                <!-- 推荐书籍模块 -->
                <div class="module-card books" id="booksModule" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-book"></i>
                        <h3 class="module-title">推荐书籍</h3>
                        <span class="module-count" id="booksCount">0</span>
                    </div>
                    <div class="module-content" id="booksContent">
                        <!-- 书籍内容将动态加载 -->
                    </div>
                </div>

                <!-- 推荐课程模块 -->
                <div class="module-card courses" id="coursesModule" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-graduation-cap"></i>
                        <h3 class="module-title">推荐课程</h3>
                        <span class="module-count" id="coursesCount">0</span>
                    </div>
                    <div class="module-content" id="coursesContent">
                        <!-- 课程内容将动态加载 -->
                    </div>
                </div>

                <!-- 相关证书模块 -->
                <div class="module-card certificates" id="certificatesModule" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-certificate"></i>
                        <h3 class="module-title">相关证书</h3>
                        <span class="module-count" id="certificatesCount">0</span>
                    </div>
                    <div class="module-content" id="certificatesContent">
                        <!-- 证书内容将动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 技能分类展示 -->
            <div class="skills-container" id="skillsContainer">
                <!-- 技能分类将动态生成 -->
            </div>

            <!-- 重新生成按钮 -->
            <div class="regenerate-section">
                <button class="regenerate-btn" id="regenerateBtn">
                    <i class="fas fa-redo"></i>
                    重新生成
                </button>
                <button class="regenerate-btn" id="testModulesBtn" style="margin-left: 1rem; background: #10b981;">
                    <i class="fas fa-flask"></i>
                    测试五个模块
                </button>
            </div>
        </section>

        <!-- 错误提示 -->
        <section class="error-section" id="errorSection" style="display: none;">
            <div class="error-card">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="error-title">生成失败</h3>
                <p class="error-message" id="errorMessage"></p>
                <button class="retry-btn" id="retryBtn">
                    <i class="fas fa-redo"></i>
                    重试
                </button>
            </div>
        </section>
        </div> <!-- 结束左侧内容区域 -->
        
        <!-- 右侧日志面板 -->
        <div class="log-panel" id="logPanel">
            <div class="log-header">
                <h3>
                    <i class="fas fa-terminal"></i>
                    AI 实时日志
                </h3>
                <div class="log-controls">
                    <button class="log-btn" id="clearLogsBtn" title="清空日志">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="log-btn" id="downloadLogsBtn" title="下载日志">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="log-btn" id="toggleLogPanelBtn" title="隐藏/显示日志">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
            <div class="log-content" id="logContent">
                <div class="log-welcome">
                    <i class="fas fa-info-circle"></i>
                    欢迎使用职途助手！请输入职位信息开始生成...
                </div>
            </div>
            <div class="log-status">
                <span class="log-count">0 条日志</span>
                <span class="log-auto-scroll">
                    <input type="checkbox" id="autoScrollLog" checked>
                    <label for="autoScrollLog">自动滚动</label>
                </span>
            </div>
        </div>
        
        <!-- AI对话框 -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <h3>
                    <i class="fas fa-robot"></i>
                    AI 智能助手
                </h3>
                <div class="chat-controls">
                    <button class="chat-btn" id="clearChatBtn" title="清空对话">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="chat-btn" id="downloadChatBtn" title="下载对话">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="chat-btn" id="toggleChatPanelBtn" title="隐藏/显示对话">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
            <div class="chat-content" id="chatContent">
                <div class="chat-welcome">
                    <i class="fas fa-robot"></i>
                    <p>你好！我是职途助手AI，可以回答你关于职业发展、技能学习的问题。</p>
                    <p>请输入你的问题开始对话吧！</p>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chatInput" 
                        placeholder="请输入你的问题..."
                        rows="2"
                        maxlength="2000"
                    ></textarea>
                    <button class="chat-send-btn" id="chatSendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="chat-status">
                    <span class="chat-count" id="chatCount">0 条对话</span>
                    <span class="chat-model">AI 模型: 百炼</span>
                </div>
            </div>
        </div>
    </div> <!-- 结束主容器 -->

    <!-- 页脚 -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 职途助手AI求职大师 - 基于Eko框架构建 | 参加"Awaken Your Web 创新挑战赛"</p>
            <div class="footer-links">
                <a href="#" class="footer-link">GitHub</a>
                <a href="#" class="footer-link">文档</a>
                <a href="#" class="footer-link">反馈</a>
            </div>
        </div>
    </footer>

    <!-- Toast 通知 -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <i class="toast-icon"></i>
            <span class="toast-message"></span>
        </div>
    </div>

    <!-- API密钥配置弹窗 -->
    <div class="config-modal" id="configModal">
        <div class="config-modal-overlay" id="configOverlay"></div>
        <div class="config-modal-content">
            <div class="config-header">
                <h3>
                    <i class="fas fa-key"></i>
                    配置API密钥
                </h3>
                <button class="config-close" id="configClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="config-body">
                <div class="config-description">
                    <p>为了使用真实AI功能生成学习内容，请配置阿里云百炼API密钥：</p>
                </div>
                <div class="config-form">
                    <div class="config-input-group">
                        <label for="apiKeyInput">阿里云百炼API密钥：</label>
                        <div class="config-input-wrapper">
                            <input 
                                type="password" 
                                id="apiKeyInput" 
                                placeholder="请输入你的API密钥" 
                                class="config-input"
                            >
                            <button class="toggle-password" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="config-help">
                        <div class="config-help-item">
                            <strong>1. 获取API密钥：</strong>
                            <a href="https://dashscope.console.aliyun.com/" target="_blank" class="config-link">
                                访问阿里云百炼控制台
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                        <div class="config-help-item">
                            <strong>2. 登录阿里云账号</strong>并创建API密钥
                        </div>
                        <div class="config-help-item">
                            <strong>3. 复制密钥</strong>并粘贴到上方输入框
                        </div>
                    </div>
                    <div class="config-status" id="configStatus">
                        <!-- 状态信息将动态显示 -->
                    </div>
                </div>
            </div>
            <div class="config-footer">
                <button class="config-btn config-btn-cancel" id="configCancel">取消</button>
                <button class="config-btn config-btn-test" id="configTest">测试连接</button>
                <button class="config-btn config-btn-save" id="configSave">保存配置</button>
            </div>
        </div>
    </div>

    <!-- 内容类型选择模态框 -->
    <div class="content-modal" id="contentModal">
        <div class="content-modal-overlay" id="contentOverlay"></div>
        <div class="content-modal-content">
            <div class="content-header">
                <h3>
                    <i class="fas fa-list-check"></i>
                    选择生成内容
                </h3>
                <button class="content-close" id="contentClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="content-body">
                <div class="content-description">
                    <p>请选择您希望生成的学习资料类型：</p>
                </div>
                <div class="content-options">
                    <label class="content-option">
                        <input type="checkbox" name="contentType" value="knowledge" checked>
                        <div class="option-card">
                            <i class="fas fa-lightbulb"></i>
                            <h4>知识点</h4>
                            <p>核心技能和知识点清单</p>
                        </div>
                    </label>
                    <label class="content-option">
                        <input type="checkbox" name="contentType" value="interview" checked>
                        <div class="option-card">
                            <i class="fas fa-question-circle"></i>
                            <h4>高频面试题</h4>
                            <p>常见面试问题和参考答案</p>
                        </div>
                    </label>
                    <label class="content-option">
                        <input type="checkbox" name="contentType" value="books">
                        <div class="option-card">
                            <i class="fas fa-book"></i>
                            <h4>推荐书籍</h4>
                            <p>相关领域专业书籍推荐</p>
                        </div>
                    </label>
                    <label class="content-option">
                        <input type="checkbox" name="contentType" value="certificates">
                        <div class="option-card">
                            <i class="fas fa-certificate"></i>
                            <h4>证书</h4>
                            <p>职业相关证书和认证</p>
                        </div>
                    </label>
                    <label class="content-option">
                        <input type="checkbox" name="contentType" value="courses">
                        <div class="option-card">
                            <i class="fas fa-graduation-cap"></i>
                            <h4>推荐课程</h4>
                            <p>在线学习课程推荐</p>
                        </div>
                    </label>
                </div>
            </div>
            <div class="content-footer">
                <button class="content-btn content-btn-cancel" id="contentCancel">取消</button>
                <button class="content-btn content-btn-confirm" id="contentConfirm">生成学习路线</button>
            </div>
        </div>
    </div>

    <!-- 简化的JavaScript初始化 -->
    <script>
        // 立即隐藏加载指示器，显示页面
        document.addEventListener('DOMContentLoaded', function() {
            const simpleLoading = document.getElementById('simpleLoading');
            if (simpleLoading) {
                simpleLoading.classList.add('hidden');
            }
            console.log('✓ 页面加载完成');
            
            // 立即修复按钮状态的备用脚本
            setTimeout(function() {
                const jobTitle = document.getElementById('jobTitle');
                const generateBtn = document.getElementById('generateBtn');
                
                if (jobTitle && generateBtn) {
                    console.log('🔧 备用修复脚本启动...');
                    
                    function updateButtonState() {
                        const hasValue = jobTitle.value.trim().length > 0;
                        generateBtn.disabled = !hasValue;
                        generateBtn.style.opacity = hasValue ? '1' : '0.6';
                        generateBtn.style.cursor = hasValue ? 'pointer' : 'not-allowed';
                        generateBtn.style.pointerEvents = 'auto';
                        
                        console.log('🔄 按钮状态更新:', {
                            hasValue,
                            disabled: generateBtn.disabled,
                            value: jobTitle.value
                        });
                    }
                    
                    // 立即更新
                    updateButtonState();
                    
                    // 监听输入变化
                    jobTitle.addEventListener('input', updateButtonState);
                    
                    // 监听热门按钮点击
                    document.querySelectorAll('.job-tag').forEach(function(tag) {
                        tag.addEventListener('click', function() {
                            const job = this.getAttribute('data-job');
                            if (job) {
                                jobTitle.value = job;
                                updateButtonState();
                                console.log('🏆 热门职位选中:', job);
                            }
                        });
                    });
                    
                    console.log('✅ 备用修复脚本已初始化');
                }
            }, 50);
        });
        
        // 如果3秒内没加载完成，强制显示页面
        setTimeout(function() {
            const simpleLoading = document.getElementById('simpleLoading');
            if (simpleLoading) {
                simpleLoading.classList.add('hidden');
            }
        }, 3000);
    </script>
    
    <!-- 主要的JavaScript文件 - 同步加载确保正确初始化 -->
    <script src="app.js"></script>
    
    <!-- 简化的初始化脚本 - 解决初始化问题 -->
    <script src="simple-init.js"></script>
    
    <!-- 职途助手补充方法 -->
    <script>
        // 简单的初始化检查
        function addJobAssistantMethods() {
            // 等待主类加载完成
            if (window.jobAssistantUI) {
                const ui = window.jobAssistantUI;
                console.log('✅ 找到 jobAssistantUI，添加补充方法...');
                
                // 添加switchTab方法
                ui.switchTab = function(tabName) {
                    if (!this.jobNameTab || !this.jobDescTab) return;
                    
                    this.jobNameTab.classList.remove('active');
                    this.jobDescTab.classList.remove('active');
                    this.jobNameContent.classList.remove('active');
                    this.jobDescContent.classList.remove('active');
                    
                    if (tabName === 'jobName') {
                        this.jobNameTab.classList.add('active');
                        this.jobNameContent.classList.add('active');
                    } else {
                        this.jobDescTab.classList.add('active');
                        this.jobDescContent.classList.add('active');
                    }
                    
                    this.updateGenerateButton && this.updateGenerateButton();
                };
                
                // 添加updateGenerateButton方法
                ui.updateGenerateButton = function() {
                    const hasJobTitle = this.jobTitle && this.jobTitle.value.trim().length > 0;
                    const hasJobDesc = this.jobDescription && this.jobDescription.value.trim().length > 0;
                    const hasUploadedFile = this.fileInput && this.fileInput.files.length > 0;
                    
                    const isJobNameTabActive = this.jobNameContent && this.jobNameContent.classList.contains('active');
                    const isValid = isJobNameTabActive ? hasJobTitle : (hasJobDesc || hasUploadedFile);
                    
                    if (this.generateBtn) {
                        this.generateBtn.disabled = !isValid;
                        this.generateBtn.style.opacity = isValid ? '1' : '0.6';
                    }
                };
                
                // 添加showContentModal方法
                ui.showContentModal = function() {
                    if (this.contentModal) {
                        this.contentModal.classList.add('show');
                        this.updateContentConfirmButton && this.updateContentConfirmButton();
                    }
                };
                
                // 添加hideContentModal方法
                ui.hideContentModal = function() {
                    if (this.contentModal) {
                        this.contentModal.classList.remove('show');
                    }
                };
                
                // 添加updateContentConfirmButton方法
                ui.updateContentConfirmButton = function() {
                    if (this.contentOptions && this.contentConfirm) {
                        const checkedOptions = Array.from(this.contentOptions).filter(cb => cb.checked);
                        this.contentConfirm.disabled = checkedOptions.length === 0;
                    }
                };
                
                // 添加startGeneration方法（核心方法）
                ui.startGeneration = async function() {
                    try {
                        console.log('🚀 开始生成学习资料');
                        
                        // 获取选中的内容类型
                        this.selectedContentTypes = [];
                        if (this.contentOptions) {
                            this.selectedContentTypes = Array.from(this.contentOptions)
                                .filter(cb => cb.checked)
                                .map(cb => cb.value);
                        }
                        
                        // 获取职位信息
                        const isJobNameTabActive = this.jobNameContent && this.jobNameContent.classList.contains('active');
                        if (isJobNameTabActive && this.jobTitle) {
                            this.currentJobInfo = {
                                type: 'jobName',
                                content: this.jobTitle.value.trim()
                            };
                        } else if (this.jobDescription) {
                            this.currentJobInfo = {
                                type: 'jobDescription',
                                content: this.jobDescription.value.trim(),
                                file: this.fileInput && this.fileInput.files[0] || null
                            };
                        }
                        
                        this.hideContentModal();
                        
                        // 显示加载状态
                        if (this.loadingSection) {
                            this.loadingSection.style.display = 'block';
                        }
                        
                        this.addLog && this.addLog('info', `💼 开始分析职位: ${this.currentJobInfo.content}`);
                        this.addLog && this.addLog('info', `🎯 选中内容类型: ${this.selectedContentTypes.join(', ')}`);
                        
                        // 调用真实API生成学习资料
                        await this.callRealAPI();
                        
                    } catch (error) {
                        console.error('生成失败:', error);
                        this.showToast && this.showToast('生成失败，请稍后重试', 'error');
                    }
                };
                
                // 添加真实API调用方法（流式版本）
                ui.callRealAPI = async function() {
                    try {
                        console.log('🚀 开始流式生成学习方案...');
                        this.addLog && this.addLog('info', '🚀 开始调用AI流式生成接口...');
                        
                        // 检查是否有API密钥
                        const apiKey = this.getStoredApiKey ? this.getStoredApiKey() : null;
                        
                        if (!apiKey) {
                            this.addLog && this.addLog('warning', '⚠️ 未配置API密钥，将尝试使用本地工具搜索课程');
                            this.showToast && this.showToast('⚠️ 未配置API密钥，将尝试使用本地工具。配置API密钥可获得更好的AI功能。', 'info', 5000);
                        }
                        
                        // 使用流式API端点
                        const response = await fetch('/api/generate-learning-plan-stream', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                topic: this.currentJobInfo.content,
                                apiKey: apiKey,
                                contentTypes: this.selectedContentTypes  // 添加用户选择的内容类型
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        // 处理流式响应
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        // 存储流式数据
                        let streamData = {
                            courses: [],
                            studyPlan: null,
                            exercises: [],
                            notes: null,
                            progress: null,
                            mindmap: null
                        };
                        
                        console.log('📊 开始处理流式响应...');
                        this.addLog && this.addLog('info', '📊 正在接收AI流式数据...');
                        
                        const processStream = async () => {
                            try {
                                while (true) {
                                    const { done, value } = await reader.read();
                                    
                                    if (done) {
                                        console.log('🏁 流式数据接收完成');
                                        this.addLog && this.addLog('success', '✅ 流式数据接收完成');
                                        
                                        // 显示最终结果
                                        this.showStreamResults(streamData);
                                        return;
                                    }
                                    
                                    buffer += decoder.decode(value, { stream: true });
                                    const lines = buffer.split('\n');
                                    
                                    // 保留最后一行（可能不完整）
                                    buffer = lines.pop() || '';
                                    
                                    for (const line of lines) {
                                        if (line.trim() === '') continue;
                                        
                                        if (line.startsWith('event: ')) {
                                            const eventType = line.slice(7).trim();
                                            console.log('📡 SSE事件类型:', eventType);
                                            continue;
                                        }
                                        
                                        if (line.startsWith('data: ')) {
                                            try {
                                                const dataStr = line.slice(6);
                                                const data = JSON.parse(dataStr);
                                                console.log('📊 收到流式数据:', data);
                                                
                                                // 处理流式事件
                                                await this.handleStreamEvent(data, streamData);
                                                
                                            } catch (e) {
                                                console.warn('⚠️ 解析流数据失败:', e.message, '原始数据:', line);
                                            }
                                        }
                                    }
                                }
                            } catch (streamError) {
                                console.error('❌ 流处理错误:', streamError);
                                this.addLog && this.addLog('error', '❌ 流处理错误: ' + streamError.message);
                                throw streamError;
                            }
                        };
                        
                        await processStream();
                        
                    } catch (error) {
                        console.error('❓ API调用失败:', error);
                        this.addLog && this.addLog('error', `❌ API调用失败: ${error.message}`);
                        
                        // 降级到模拟数据
                        this.showToast && this.showToast('API调用失败，使用模拟数据展示', 'warning', 3000);
                        await this.simulateGeneration();
                        this.generateMockData();
                    }
                };
                
                // 添加处理流式事件的方法
                ui.handleStreamEvent = async function(data, streamData) {
                    console.log('📊 流式事件:', data);
                    
                    // 处理开始事件
                    if (data.message && data.message.includes('开始生成')) {
                        this.addLog && this.addLog('info', '🚀 ' + data.message);
                        return;
                    }
                    
                    // 根据事件类型处理
                    if (data.step) {
                        console.log(`🔄 处理步骤: ${data.step}, 进度: ${data.progress}%`);
                        this.addLog && this.addLog('info', `🔄 ${data.message || data.step}`);
                        
                        // 如果有数据，更新对应部分
                        if (data.data) {
                            console.log(`📊 收到 ${data.step} 数据:`, data.data);
                            console.log(`🎆 即将显示 ${data.step} 内容...`);
                            
                            switch (data.step) {
                                case 'courses':
                                    streamData.courses = data.data;
                                    console.log('🎓 开始显示课程推荐...');
                                    this.displayStreamCourses(data.data);
                                    this.addLog && this.addLog('success', '✅ 课程推荐生成完成');
                                    console.log('✅ 课程推荐显示完成');
                                    break;
                                case 'studyPlan':
                                    streamData.studyPlan = data.data;
                                    console.log('💡 开始显示知识点...');
                                    // 使用知识点显示方法而不是学习计划
                                    this.displayStreamKnowledge(data.data.phases || []);
                                    this.addLog && this.addLog('success', '✅ 知识点生成完成');
                                    console.log('✅ 知识点显示完成');
                                    break;
                                case 'exercises':
                                    streamData.exercises = data.data;
                                    console.log('❓ 开始显示面试题...');
                                    this.displayStreamExercises(data.data);
                                    this.addLog && this.addLog('success', '✅ 面试题生成完成');
                                    console.log('✅ 面试题显示完成');
                                    break;
                                case 'notes':
                                    streamData.notes = data.data;
                                    console.log('📚 开始显示推荐书籍...');
                                    this.displayStreamNotes(data.data);
                                    this.addLog && this.addLog('success', '✅ 推荐书籍生成完成');
                                    console.log('✅ 推荐书籍显示完成');
                                    break;
                                case 'progress':
                                    streamData.progress = data.data;
                                    console.log('🏆 开始显示相关证书...');
                                    this.displayStreamCertificates(data.data);
                                    this.addLog && this.addLog('success', '✅ 相关证书生成完成');
                                    console.log('✅ 相关证书显示完成');
                                    break;
                                case 'mindmap':
                                    streamData.mindmap = data.data;
                                    console.log('🧠 开始显示思维导图...');
                                    this.displayStreamMindmap(data.data);
                                    this.addLog && this.addLog('success', '✅ 思维导图生成完成');
                                    console.log('✅ 思维导图显示完成');
                                    break;
                                default:
                                    console.warn(`⚠️ 未知的步骤类型: ${data.step}`);
                            }
                        } else {
                            console.warn(`⚠️ ${data.step} 步骤没有数据`);
                        }
                    }
                    
                    // 处理完成事件
                    if (data.result) {
                        console.log('✅ 流式生成完成，更新最终结果');
                        console.log('📊 最终结果数据:', data.result);
                        Object.assign(streamData, data.result);
                        
                        // 清空结果容器，准备显示5个独立分块
                        if (this.skillsContainer) {
                            this.skillsContainer.innerHTML = '';
                            console.log('🗑️ 已清空结果容器，准备显示独立分块');
                        }
                        
                        // 确保显示最终结果中的所有内容 - 为每种选中的内容类型显示独立分块
                        const selectedTypes = this.selectedContentTypes || ['knowledge', 'interview'];
                        console.log('🔍 用户选择的内容类型:', selectedTypes);
                        
                        // 1. 知识点 - 使用studyPlan数据
                        if (selectedTypes.includes('knowledge') && data.result.studyPlan) {
                            console.log('💡 显示知识点分块');
                            this.displayStreamKnowledge(data.result.studyPlan.phases || []);
                        }
                        
                        // 2. 高频面试题 - 使用exercises数据
                        if (selectedTypes.includes('interview') && data.result.exercises) {
                            console.log('❓ 显示面试题分块');
                            this.displayStreamExercises(data.result.exercises);
                        }
                        
                        // 3. 推荐书籍 - 使用notes数据
                        if (selectedTypes.includes('books') && data.result.notes) {
                            console.log('📚 显示书籍分块');
                            this.displayStreamNotes(data.result.notes);
                        }
                        
                        // 4. 相关证书 - 使用progress数据
                        if (selectedTypes.includes('certificates') && data.result.progress) {
                            console.log('🏆 显示证书分块');
                            this.displayStreamCertificates(data.result.progress);
                        }
                        
                        // 5. 推荐课程 - 使用courses数据
                        if (selectedTypes.includes('courses') && data.result.courses) {
                            console.log('🎓 显示课程分块');
                            this.displayStreamCourses(data.result.courses);
                        }
                        
                        // 6. 思维导图 - 始终显示（作为最后一个独立分块）
                        if (data.result.mindmap) {
                            console.log('🧠 显示思维导图分块');
                            this.displayStreamMindmap(data.result.mindmap);
                        }
                        
                        this.addLog && this.addLog('success', '🎉 学习方案生成完成！');
                    }
                    
                    // 处理错误事件
                    if (data.error) {
                        console.error('❌ 流式生成错误:', data.error);
                        this.addLog && this.addLog('error', '❌ 流式生成错误: ' + data.error);
                        throw new Error(data.error);
                    }
                };
                
                // 修改课程显示方法 - 使用独立分块显示
                ui.displayStreamCourses = function(courses) {
                    if (!courses || !Array.isArray(courses) || courses.length === 0) {
                        console.warn('⚠️ 课程数据为空或无效');
                        return;
                    }
                    
                    console.log('🎓 显示推荐课程:', courses);
                    
                    // 格式化课程数据
                    const coursesData = courses.map(course => {
                        const rating = course.rating ? parseFloat(course.rating).toFixed(1) : 'N/A';
                        const students = course.students ? course.students.toLocaleString() : '0';
                        const difficulty = this.translateDifficulty ? this.translateDifficulty(course.difficulty) : course.difficulty || '未知';
                        const highlights = course.highlights ? course.highlights.join('、') : '';
                        
                        return `<div class="course-item" style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e5e5e5; border-radius: 8px; background: #f9f9f9;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #4f46e5;">${course.title || '未命名课程'}</h4>
                            <p><strong>🏢 平台:</strong> ${course.platform || '未知平台'}</p>
                            <p><strong>📊 难度:</strong> ${difficulty}</p>
                            <p><strong>⭐ 评分:</strong> ${rating}/5 | <strong>👥 学生:</strong> ${students}人</p>
                            <p><strong>⏱️ 时长:</strong> ${course.duration || '未知'} | <strong>💰 价格:</strong> ${course.price === 0 ? '免费' : '￥' + (course.price || '未知')}</p>
                            ${highlights ? `<p><strong>🎆 亮点:</strong> ${highlights}</p>` : ''}
                            ${course.description ? `<p style="color: #444; font-size: 0.9rem;">${course.description}</p>` : ''}
                        </div>`;
                    });
                    
                    this.addIndependentSkillCategory('🎓 推荐课程', 'courses', coursesData, 'fas fa-graduation-cap');
                };
                
                ui.displayStreamStudyPlan = function(studyPlan) {
                    if (!studyPlan) {
                        console.warn('⚠️ 学习计划数据为空');
                        return;
                    }
                    
                    console.log('📋 显示学习计划:', studyPlan);
                    
                    // 为学习计划创建独立的显示块
                    const studyPlanData = studyPlan.phases ? studyPlan.phases.map(phase => 
                        `<strong>${phase.name || '未命名阶段'}</strong><br>${(phase.tasks || []).map(task => `• ${task}`).join('<br>')}`
                    ) : ['暂无学习计划数据'];
                    
                    this.addIndependentSkillCategory('📋 学习计划', 'knowledge', studyPlanData, 'fas fa-clipboard-list');
                };
                
                ui.displayStreamExercises = function(exercises) {
                    if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
                        console.warn('⚠️ 练习题数据为空或无效');
                        return;
                    }
                    
                    console.log('📝 显示练习题:', exercises);
                    
                    // 为练习题创建独立的显示块
                    const exercisesData = exercises.map((exercise, index) => `${index + 1}. ${exercise || '空题目'}`);
                    
                    this.addIndependentSkillCategory('❓ 高频面试题', 'interview', exercisesData, 'fas fa-question-circle');
                };
                
                ui.displayStreamNotes = function(notes) {
                    if (!notes) {
                        console.warn('⚠️ 笔记数据为空');
                        return;
                    }
                    
                    console.log('📖 显示学习笔记:', notes);
                    
                    // 为学习笔记创建独立的显示块
                    const notesData = notes.keyPoints ? notes.keyPoints.map(point => point || '空内容') : ['暂无关键知识点'];
                    
                    this.addIndependentSkillCategory('📚 推荐书籍', 'books', notesData, 'fas fa-book');
                };
                
                // 添加独立技能分类显示方法
                ui.addIndependentSkillCategory = function(title, contentType, items, iconClass) {
                    if (!this.skillsContainer) return;
                    
                    const selectedTypes = this.selectedContentTypes || ['knowledge', 'interview'];
                    
                    // 检查是否应该显示这个内容类型
                    if (!selectedTypes.includes(contentType)) {
                        console.log(`🚫 跳过显示 ${title}，因为用户未选择 ${contentType} 类型`);
                        return;
                    }
                    
                    const skillDiv = document.createElement('div');
                    skillDiv.className = 'skill-category';
                    skillDiv.innerHTML = `
                        <div class="skill-header" onclick="this.parentElement.classList.toggle('collapsed')">
                            <h3 class="skill-title">
                                <i class="${iconClass}"></i>
                                ${title}
                            </h3>
                            <i class="fas fa-chevron-down skill-toggle"></i>
                        </div>
                        <div class="skill-content">
                            <div class="content-types">
                                <div class="content-type">
                                    <div class="content-type-body">
                                        ${this.renderContentItems(items)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    this.skillsContainer.appendChild(skillDiv);
                    console.log(`✅ 添加独立内容块: ${title}`);
                };
                
                // 添加内容渲染辅助方法
                ui.renderContentItems = function(items) {
                    if (!items || !Array.isArray(items)) {
                        return '<p>暂无数据</p>';
                    }
                    
                    return items.map(item => {
                        if (typeof item === 'string') {
                            return `<div class="content-item">${item}</div>`;
                        } else {
                            return `<div class="content-item">${item}</div>`;
                        }
                    }).join('');
                };
                
                // 修改课程显示方法
                ui.displayStreamCourses = function(courses) {
                    if (!courses || !Array.isArray(courses) || courses.length === 0) {
                        console.warn('⚠️ 课程数据为空或无效');
                        return;
                    }
                    
                    console.log('🎓 显示推荐课程:', courses);
                    
                    // 格式化课程数据
                    const coursesData = courses.map(course => {
                        return `<div class="course-item">
                            <h4>${course.title || '未命名课程'}</h4>
                            <p><strong>平台:</strong> ${course.platform || '未知平台'}</p>
                            <p><strong>难度:</strong> ${this.translateDifficulty ? this.translateDifficulty(course.difficulty) : course.difficulty || '未知'}</p>
                            <p><strong>评分:</strong> ${course.rating || 'N/A'}</p>
                            <p>${course.description || '暂无描述'}</p>
                        </div>`;
                    });
                    
                    this.addIndependentSkillCategory('🎓 推荐课程', 'courses', coursesData, 'fas fa-graduation-cap');
                };
                
                // 添加证书显示方法
                ui.displayStreamCertificates = function(certificates) {
                    if (!certificates || !Array.isArray(certificates) || certificates.length === 0) {
                        // 生成默认证书推荐
                        const jobTitle = this.currentJobInfo?.content || '专业技能';
                        certificates = [
                            `${jobTitle}相关职业认证`,
                            '行业权威证书推荐',
                            '技能提升认证课程',
                            '专业能力等级证书'
                        ];
                    }
                    
                    console.log('🏆 显示相关证书:', certificates);
                    this.addIndependentSkillCategory('🏆 相关证书', 'certificates', certificates, 'fas fa-certificate');
                };
                
                // 添加知识点显示方法
                ui.displayStreamKnowledge = function(knowledge) {
                    const knowledgeModule = document.getElementById('knowledgeModule');
                    const knowledgeContent = document.getElementById('knowledgeContent');
                    const knowledgeCount = document.getElementById('knowledgeCount');
                    
                    if (!knowledgeModule || !knowledgeContent) {
                        console.error('⚠️ 知识点模块容器不存在');
                        return;
                    }
                    
                    if (!knowledge || !Array.isArray(knowledge) || knowledge.length === 0) {
                        const jobTitle = this.currentJobInfo?.content || '专业技能';
                        knowledge = [
                            `${jobTitle}基础理论与概念`,
                            '行业最佳实践和标准',
                            '相关工具和技术栈',
                            '实际项目应用案例'
                        ];
                    }
                    
                    console.log('💡 显示知识点:', knowledge);
                    
                    const knowledgeHtml = knowledge.map((item, index) => {
                        const content = typeof item === 'string' ? item : item.content || item.title || '未知内容';
                        return `<div class="knowledge-item"><div class="knowledge-number">${index + 1}</div><div class="knowledge-text">${content}</div></div>`;
                    }).join('');
                    
                    knowledgeContent.innerHTML = `<div class="knowledge-list">${knowledgeHtml}</div>`;
                    knowledgeCount.textContent = knowledge.length;
                    knowledgeModule.style.display = 'block';
                    
                    console.log(`✅ 知识点模块显示完成（${knowledge.length}个项目）`);
                };
                
                // 添加面试题显示方法
                ui.displayStreamExercises = function(exercises) {
                    const interviewModule = document.getElementById('interviewModule');
                    const interviewContent = document.getElementById('interviewContent');
                    const interviewCount = document.getElementById('interviewCount');
                    
                    if (!interviewModule || !interviewContent) {
                        console.error('⚠️ 面试题模块容器不存在');
                        return;
                    }
                    
                    if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
                        const jobTitle = this.currentJobInfo?.content || '专业技能';
                        exercises = [
                            `请介绍您对${jobTitle}岗位的理解`,
                            `您在${jobTitle}方面有哪些实战经验？`,
                            `如何解决${jobTitle}工作中的常见问题？`,
                            `描述一个具有挑战性的${jobTitle}项目`,
                            `您认为${jobTitle}未来的发展趋势是什么？`
                        ];
                    }
                    
                    console.log('❓ 显示面试题:', exercises);
                    
                    // 分类面试题
                    const categories = this.categorizeInterviewQuestions(exercises);
                    
                    // 生成面试题HTML
                    const interviewHtml = `
                        <div class="interview-header">
                            <div class="interview-stats">
                                <div class="stats-item">
                                    <span class="stats-number">${exercises.length}</span>
                                    <span class="stats-label">总题目</span>
                                </div>
                                <div class="stats-item">
                                    <span class="stats-number">${categories.length}</span>
                                    <span class="stats-label">已分类</span>
                                </div>
                            </div>
                            <div class="interview-description">
                                精选企业高频面试题目，AI智能评分助您提升面试表现
                            </div>
                        </div>
                        
                        <div class="interview-categories">
                            ${categories.map(category => `
                                <div class="interview-category">
                                    <div class="category-header">
                                        <div class="category-tags">
                                            <span class="category-tag primary">${category.type}</span>
                                            <span class="category-tag secondary">${category.level}</span>
                                        </div>
                                        <div class="category-meta">
                                            <span class="question-count">👁 ${category.views}</span>
                                            <span class="difficulty-rating">⭐ ${category.rating}</span>
                                            <span class="time-estimate">⏰ 建议用时 ${category.timeEstimate}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="question-content">
                                        <h4 class="question-title">${category.question}</h4>
                                        <div class="question-description">
                                            ${category.description}
                                        </div>
                                    </div>
                                    
                                    <div class="question-actions">
                                        <button class="action-btn practice-btn" data-question="${category.question}">
                                            <i class="fas fa-comments"></i>
                                            练习答案
                                        </button>
                                        <button class="action-btn ai-btn" data-question="${category.question}">
                                            <i class="fas fa-robot"></i>
                                            AI评分
                                        </button>
                                        <button class="action-btn favorite-btn">
                                            <i class="far fa-heart"></i>
                                        </button>
                                        <button class="action-btn bookmark-btn">
                                            <i class="far fa-bookmark"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    interviewContent.innerHTML = interviewHtml;
                    interviewCount.textContent = exercises.length;
                    interviewModule.style.display = 'block';
                    
                    // 添加事件监听器
                    this.addInterviewEventListeners();
                    
                    console.log(`✅ 面试题模块显示完成（${exercises.length}个项目）`);
                };
                
                // 面试题分类方法
                ui.categorizeInterviewQuestions = function(exercises) {
                    const questionTypes = ['基础理论', '技术实战', '项目经验', '问题解决', '发展规划'];
                    const levels = ['初级', '中级', '高级'];
                    
                    return exercises.map((question, index) => {
                        const typeIndex = index % questionTypes.length;
                        const levelIndex = Math.floor(index / 2) % levels.length;
                        
                        return {
                            question: question,
                            type: questionTypes[typeIndex],
                            level: levels[levelIndex],
                            views: (Math.floor(Math.random() * 3000) + 500).toLocaleString(),
                            rating: (4.0 + Math.random() * 0.9).toFixed(1),
                            timeEstimate: `${Math.floor(Math.random() * 8) + 3} 分钟`,
                            description: this.generateQuestionDescription(question)
                        };
                    });
                };
                
                // 生成题目描述
                ui.generateQuestionDescription = function(question) {
                    // 根据问题类型生成相应的描述
                    if (question.includes('理解') || question.includes('介绍')) {
                        return '考察对核心概念的理解和整体认知能力';
                    } else if (question.includes('实战') || question.includes('经验')) {
                        return '评估实际项目经验和解决问题的能力';
                    } else if (question.includes('设计') || question.includes('架构')) {
                        return '测试系统设计和架构思维能力';
                    } else if (question.includes('优化') || question.includes('性能')) {
                        return '考察技术深度和优化思维';
                    } else if (question.includes('微服务') || question.includes('分布式')) {
                        return '评估对复杂系统架构的理解能力';
                    } else {
                        return '综合考察专业技能和解决问题的思路';
                    }
                };
                
                // 添加面试题事件监听器
                ui.addInterviewEventListeners = function() {
                    // 使用事件委托处理动态添加的元素
                    const interviewContent = document.getElementById('interviewContent');
                    if (!interviewContent) return;
                    
                    // 练习答案按钮点击事件
                    interviewContent.addEventListener('click', (e) => {
                        if (e.target.closest('.practice-btn')) {
                            const button = e.target.closest('.practice-btn');
                            const question = button.getAttribute('data-question');
                            console.log('🎯 点击练习答案按钮:', question);
                            this.fillAIAssistantInput(question);
                            
                            // 添加点击反馈
                            button.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                button.style.transform = 'scale(1)';
                            }, 150);
                        }
                        
                        // AI评分按钮点击事件
                        if (e.target.closest('.ai-btn')) {
                            const button = e.target.closest('.ai-btn');
                            const question = button.getAttribute('data-question');
                            console.log('🤖 点击AI评分按钮:', question);
                            const aiPrompt = `请帮我分析这道面试题的答题要点和评分标准：${question}`;
                            this.fillAIAssistantInput(aiPrompt);
                            
                            // 添加点击反馈
                            button.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                button.style.transform = 'scale(1)';
                            }, 150);
                        }
                        
                        // 收藏按钮点击事件
                        if (e.target.closest('.favorite-btn')) {
                            const button = e.target.closest('.favorite-btn');
                            const icon = button.querySelector('i');
                            if (icon.classList.contains('far')) {
                                icon.classList.replace('far', 'fas');
                                icon.style.color = '#ef4444';
                                this.showToast('已添加到收藏夹', 'success');
                            } else {
                                icon.classList.replace('fas', 'far');
                                icon.style.color = '';
                                this.showToast('已取消收藏', 'info');
                            }
                        }
                        
                        // 书签按钮点击事件
                        if (e.target.closest('.bookmark-btn')) {
                            const button = e.target.closest('.bookmark-btn');
                            const icon = button.querySelector('i');
                            if (icon.classList.contains('far')) {
                                icon.classList.replace('far', 'fas');
                                icon.style.color = '#f59e0b';
                                this.showToast('已添加书签', 'success');
                            } else {
                                icon.classList.replace('fas', 'far');
                                icon.style.color = '';
                                this.showToast('已取消书签', 'info');
                            }
                        }
                    });
                    
                    console.log('✅ 面试题事件监听器已添加');
                };
                
                // 填入AI助手输入框的方法
                ui.fillAIAssistantInput = function(text) {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = text;
                        chatInput.focus();
                        
                        // 触发input事件以更新发送按钮状态
                        const inputEvent = new Event('input', { bubbles: true });
                        chatInput.dispatchEvent(inputEvent);
                        
                        this.showToast('内容已填入AI助手，可以直接提问！', 'success');
                        console.log('✅ 内容已填入AI助手:', text);
                    } else {
                        console.warn('⚠️ 未找到AI助手输入框');
                        this.showToast('未找到AI助手输入框', 'error');
                    }
                };
                
                // Toast提示方法
                ui.showToast = function(message, type = 'info') {
                    const toast = document.getElementById('toast');
                    const toastMessage = toast?.querySelector('.toast-message');
                    const toastIcon = toast?.querySelector('.toast-icon');
                    
                    if (toast && toastMessage && toastIcon) {
                        // 设置图标
                        const icons = {
                            success: 'fas fa-check-circle',
                            error: 'fas fa-exclamation-circle',
                            warning: 'fas fa-exclamation-triangle',
                            info: 'fas fa-info-circle'
                        };
                        
                        toastIcon.className = `toast-icon ${icons[type] || icons.info}`;
                        toastMessage.textContent = message;
                        toast.className = `toast show toast-${type}`;
                        
                        // 3秒后自动隐藏
                        setTimeout(() => {
                            toast.className = 'toast';
                        }, 3000);
                    }
                };
                
                // 修改课程显示方法
                ui.displayStreamCourses = function(courses) {
                    const coursesModule = document.getElementById('coursesModule');
                    const coursesContent = document.getElementById('coursesContent');
                    const coursesCount = document.getElementById('coursesCount');
                    
                    if (!coursesModule || !coursesContent) {
                        console.error('⚠️ 课程模块容器不存在');
                        return;
                    }
                    
                    if (!courses || !Array.isArray(courses) || courses.length === 0) {
                        const jobTitle = this.currentJobInfo?.content || '专业技能';
                        courses = [{
                            title: `${jobTitle}零基础入门课程`,
                            platform: 'Coursera',
                            difficulty: '初级',
                            rating: '4.8',
                            students: '50,000+',
                            description: '从零开始学习核心技能'
                        }];
                    }
                    
                    console.log('🎓 显示推荐课程:', courses);
                    
                    const coursesHtml = courses.map((course, index) => {
                        const title = course.title || '未命名课程';
                        const platform = course.platform || '未知平台';
                        const difficulty = course.difficulty || '未知';
                        const rating = course.rating || 'N/A';
                        const students = course.students || '未知';
                        const description = course.description || '暂无描述';
                        
                        return `<div class="course-item"><div class="course-number">${index + 1}</div><div class="course-info"><h4 class="course-title">${title}</h4><div class="course-meta"><span class="course-platform">🏛️ ${platform}</span><span class="course-difficulty">🎯 ${difficulty}</span><span class="course-rating">⭐ ${rating}</span><span class="course-students">👥 ${students}</span></div><p class="course-description">${description}</p></div></div>`;
                    }).join('');
                    
                    coursesContent.innerHTML = `<div class="courses-list">${coursesHtml}</div>`;
                    coursesCount.textContent = courses.length;
                    coursesModule.style.display = 'block';
                    
                    console.log(`✅ 课程模块显示完成（${courses.length}个项目）`);
                };
                
                // 修改证书显示方法
                ui.displayStreamCertificates = function(certificates) {
                    const certificatesModule = document.getElementById('certificatesModule');
                    const certificatesContent = document.getElementById('certificatesContent');
                    const certificatesCount = document.getElementById('certificatesCount');
                    
                    if (!certificatesModule || !certificatesContent) {
                        console.error('⚠️ 证书模块容器不存在');
                        return;
                    }
                    
                    if (!certificates || !Array.isArray(certificates) || certificates.length === 0) {
                        const jobTitle = this.currentJobInfo?.content || '专业技能';
                        certificates = [{
                            name: `${jobTitle}专业认证`,
                            provider: '行业权威机构',
                            difficulty: '中级',
                            duration: '3-6个月',
                            value: '提升职业竞争力，获得行业认可'
                        }];
                    }
                    
                    console.log('🏆 显示相关证书:', certificates);
                    
                    const certificatesHtml = certificates.map((cert, index) => {
                        const name = (typeof cert === 'string') ? cert : (cert.name || '未知证书');
                        const provider = (typeof cert === 'object' && cert.provider) ? cert.provider : '未知机构';
                        const difficulty = (typeof cert === 'object' && cert.difficulty) ? cert.difficulty : '未知';
                        const duration = (typeof cert === 'object' && cert.duration) ? cert.duration : '未知';
                        const value = (typeof cert === 'object' && cert.value) ? cert.value : '专业能力认证';
                        
                        return `<div class="certificate-item"><div class="certificate-number">${index + 1}</div><div class="certificate-info"><h4 class="certificate-name">${name}</h4><div class="certificate-meta"><span class="certificate-provider">🏢 ${provider}</span><span class="certificate-difficulty">🎯 ${difficulty}</span><span class="certificate-duration">⏰ ${duration}</span></div><p class="certificate-value">${value}</p></div></div>`;
                    }).join('');
                    
                    certificatesContent.innerHTML = `<div class="certificates-list">${certificatesHtml}</div>`;
                    certificatesCount.textContent = certificates.length;
                    certificatesModule.style.display = 'block';
                    
                    console.log(`✅ 证书模块显示完成（${certificates.length}个项目）`);
                };
                
                // 恢复思维导图显示方法 - 这是核心功能不能删除！
                ui.displayStreamMindmap = function(mindmap) {
                    if (!mindmap) {
                        console.warn('⚠️ 思维导图数据为空');
                        return;
                    }
                    
                    console.log('🧠 显示思维导图:', mindmap);
                    
                    // 处理思维导图显示
                    if (this.mindmapContent) {
                        let content = '';
                        if (mindmap.html) {
                            content = mindmap.html;
                        } else if (mindmap.content) {
                            content = `
                                <div class="mindmap-container">
                                    <div class="mindmap-fallback">
                                        <h3>${mindmap.title || '学习思维导图'}</h3>
                                        <div class="mindmap-tree">
                                            ${this.convertMarkdownToTree ? this.convertMarkdownToTree(mindmap.content) : mindmap.content}
                                        </div>
                                        <div class="mindmap-info">
                                            <p><strong>🧠 真实AI生成的思维导图：</strong></p>
                                            <ul>
                                                <li>• 基于大模型分析生成</li>
                                                <li>• 个性化学习路径推荐</li>
                                                <li>• 结合职位需求与学习目标</li>
                                                <li>• 智能化学习计划定制</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        this.mindmapContent.innerHTML = content;
                        
                        // 更新思维导图状态
                        const mindmapStatus = document.getElementById('mindmapStatus');
                        if (mindmapStatus) {
                            mindmapStatus.textContent = '完成';
                            mindmapStatus.className = 'card-status completed';
                        }
                    }
                };
                
                ui.showStreamResults = function(streamData) {
                    console.log('🎉 显示流式结果:', streamData);
                    
                    // 隐藏加载状态
                    if (this.loadingSection) {
                        this.loadingSection.style.display = 'none';
                    }
                    
                    // 显示结果区域
                    if (this.resultsSection) {
                        this.resultsSection.style.display = 'block';
                    }
                    
                    // 更新职位显示
                    if (this.topicDisplay) {
                        this.topicDisplay.textContent = this.currentJobInfo.content;
                    }
                    
                    // 更新生成时间
                    if (this.generationTime) {
                        this.generationTime.textContent = new Date().toLocaleString();
                    }
                    
                    this.addLog && this.addLog('success', '✅ 学习方案生成完成');
                };
                
                // 添加难度翻译方法
                ui.translateDifficulty = function(difficulty) {
                    const difficultyMap = {
                        'beginner': '初级',
                        'intermediate': '中级', 
                        'advanced': '高级',
                        'expert': '专家级',
                        'unknown': '未知'
                    };
                    return difficultyMap[difficulty] || '未知';
                };
                
                // 添加辅助生成方法
                ui.generateInterviewQuestions = function(phaseName) {
                    return [
                        `${phaseName}相关的核心问题`,
                        `实际应用场景面试题`,
                        `问题解决思路分析`
                    ];
                };
                
                ui.generateBookRecommendations = function(phaseName) {
                    return [
                        `${phaseName}相关专业书籍`,
                        `实战指南和最佳实践`
                    ];
                };
                
                ui.generateCertificates = function(phaseName) {
                    return [
                        `${phaseName}相关职业认证`,
                        `行业权威证书推荐`
                    ];
                };
                
                ui.generateCourses = function(phaseName) {
                    return [
                        `${phaseName}在线学习课程`,
                        `实战项目教程`
                    ];
                };
                
                // 添加获取存储的API密钥方法
                ui.getStoredApiKey = function() {
                    return localStorage.getItem('ai_learning_companion_api_key') || '';
                };
                
                // 添加模拟生成过程
                ui.simulateGeneration = async function() {
                    console.log('📊 模拟生成过程开始');
                    
                    // 更新进度条和步骤
                    await this.updateProgressWithSteps([
                        { step: 1, progress: 20, message: '分析职位技能需求...' },
                        { step: 2, progress: 40, message: '生成核心知识点...' },
                        { step: 3, progress: 60, message: '整理高频面试题...' },
                        { step: 4, progress: 80, message: '推荐学习资源...' },
                        { step: 5, progress: 100, message: '生成思维导图...' }
                    ]);
                    
                    // 显示结果
                    this.showResults();
                };
                
                // 添加进度更新方法
                ui.updateProgressWithSteps = async function(steps) {
                    for (const stepData of steps) {
                        // 更新当前步骤状态
                        this.updateStepStatus(stepData.step, 'active');
                        
                        // 更新进度条
                        this.updateProgressBar(stepData.progress);
                        
                        // 更新加载标题
                        this.updateLoadingTitle(stepData.message);
                        
                        // 添加日志
                        this.addLog && this.addLog('info', `🔄 ${stepData.message}`);
                        
                        // 等待一段时间模拟处理
                        await this.sleep(1200);
                        
                        // 标记步骤为完成
                        this.updateStepStatus(stepData.step, 'completed');
                    }
                };
                
                // 添加步骤状态更新方法
                ui.updateStepStatus = function(stepNumber, status) {
                    const stepElement = document.getElementById(`step${stepNumber}`);
                    if (stepElement) {
                        stepElement.className = `step ${status}`;
                    }
                };
                
                // 添加进度条更新方法
                ui.updateProgressBar = function(progress) {
                    const progressBar = document.querySelector('.progress-bar');
                    const progressText = document.querySelector('.progress-text');
                    
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                    }
                    if (progressText) {
                        progressText.textContent = `${progress}%`;
                    }
                };
                
                // 添加加载标题更新方法
                ui.updateLoadingTitle = function(message) {
                    const loadingTitle = document.querySelector('.loading-title');
                    if (loadingTitle) {
                        loadingTitle.textContent = message;
                    }
                };
                
                // 添加睡眠方法
                ui.sleep = function(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                };
                
                // 添加显示结果方法
                ui.showResults = function() {
                    // 隐藏加载状态
                    if (this.loadingSection) {
                        this.loadingSection.style.display = 'none';
                    }
                    
                    // 显示结果区域
                    if (this.resultsSection) {
                        this.resultsSection.style.display = 'block';
                    }
                    
                    // 更新结果信息
                    if (this.topicDisplay && this.currentJobInfo) {
                        this.topicDisplay.textContent = this.currentJobInfo.content;
                    }
                    if (this.generationTime) {
                        this.generationTime.textContent = new Date().toLocaleString();
                    }
                    
                    this.addLog && this.addLog('info', '✅ 学习资料显示完成');
                    
                    // 注意：不在这里生成数据，数据在callRealAPI中处理
                };
                
                // 添加生成模拟数据方法
                ui.generateMockData = function() {
                    if (!this.skillsContainer) return;
                    
                    // 生成基于职位的技能分类数据
                    const jobTitle = this.currentJobInfo?.content || '前端工程师';
                    const mockSkills = this.generateJobSpecificSkills(jobTitle);
                    
                    this.skillsContainer.innerHTML = '';
                    
                    // 生成技能分类
                    mockSkills.forEach(skill => {
                        this.addSkillCategory(skill.name, skill.content);
                    });
                    
                    // 生成思维导图
                    this.generateMindmapForJob(jobTitle, mockSkills);
                    
                    this.addLog && this.addLog('info', '📈 职位学习资料已生成');
                };
                
                // 添加基于职位的技能生成方法
                ui.generateJobSpecificSkills = function(jobTitle) {
                    const skillTemplates = {
                        '前端工程师': [
                            {
                                name: 'HTML/CSS 基础技能',
                                content: {
                                    knowledge: ['HTML5 语义化标签', 'CSS3 布局技术', '响应式设计', 'Flexbox 和 Grid'],
                                    interview: ['CSS 选择器优先级', 'BFC 原理和应用', '浏览器兼容性处理'],
                                    books: ['《CSS 揭秘》', '《HTML5 程序设计》'],
                                    certificates: ['前端开发工程师认证'],
                                    courses: ['CSS 高级布局技术', 'HTML5 实战项目']
                                }
                            },
                            {
                                name: 'JavaScript 核心技术',
                                content: {
                                    knowledge: ['ES6+ 新特性', '异步编程', '原型链和继承', '模块化开发'],
                                    interview: ['闭包和作用域', '事件循环机制', 'Promise 和 async/await', '防抖和节流'],
                                    books: ['《JavaScript 高级程序设计》', '《你不知道的 JavaScript》'],
                                    certificates: ['JavaScript 开发者认证'],
                                    courses: ['JavaScript 进阶教程', 'ES6+ 实战应用']
                                }
                            },
                            {
                                name: '前端框架',
                                content: {
                                    knowledge: ['React/Vue 核心原理', '组件化开发', '状态管理', '路由系统'],
                                    interview: ['虚拟DOM 原理', '组件生命周期', 'Redux/Vuex 状态管理', '性能优化技巧'],
                                    books: ['《React 进阶之道》', '《Vue.js 实战》'],
                                    certificates: ['React 开发者认证', 'Vue.js 专业认证'],
                                    courses: ['React 全家桶实战', 'Vue3 企业级应用开发']
                                }
                            }
                        ],
                        '后端工程师': [
                            {
                                name: 'Java 核心技术',
                                content: {
                                    knowledge: ['Java 基础语法', '面向对象编程', '集合框架', '多线程编程'],
                                    interview: ['JVM 内存模型', '垃圾回收机制', '线程同步和锁', 'Spring 框架原理'],
                                    books: ['《深入理解 Java 虚拟机》', '《Java 并发编程实战》'],
                                    certificates: ['Oracle Java 认证', 'Spring 专业认证'],
                                    courses: ['Java 高级编程', 'Spring Boot 微服务开发']
                                }
                            },
                            {
                                name: '数据库技术',
                                content: {
                                    knowledge: ['MySQL 数据库设计', 'SQL 查询优化', 'Redis 缓存技术', '数据库事务'],
                                    interview: ['数据库索引原理', 'ACID 特性', '主从复制', '分库分表策略'],
                                    books: ['《MySQL 必知必会》', '《高性能 MySQL》'],
                                    certificates: ['MySQL DBA 认证', 'Redis 专业认证'],
                                    courses: ['MySQL 性能优化', 'Redis 实战应用']
                                }
                            }
                        ],
                        'AI工程师': [
                            {
                                name: 'Python 与机器学习',
                                content: {
                                    knowledge: ['Python 基础语法', 'NumPy 和 Pandas', 'Scikit-learn', '深度学习框架'],
                                    interview: ['机器学习算法原理', '神经网络架构', '模型训练与优化', '过拟合与正则化'],
                                    books: ['《机器学习实战》', '《深度学习》'],
                                    certificates: ['TensorFlow 开发者认证', 'AWS ML 专业认证'],
                                    courses: ['TensorFlow 实战', 'PyTorch 深度学习']
                                }
                            }
                        ],
                        '产品经理': [
                            {
                                name: '产品设计与管理',
                                content: {
                                    knowledge: ['用户需求分析', '产品设计方法', '数据分析', '项目管理'],
                                    interview: ['产品生命周期管理', '用户体验设计', 'A/B 测试', '竞品分析'],
                                    books: ['《人人都是产品经理》', '《精益创业》'],
                                    certificates: ['PMP 项目管理认证', '产品经理专业认证'],
                                    courses: ['产品经理实战', '用户体验设计']
                                }
                            }
                        ]
                    };
                    
                    // 查找匹配的技能模板
                    for (const [job, skills] of Object.entries(skillTemplates)) {
                        if (jobTitle.includes(job)) {
                            return skills;
                        }
                    }
                    
                    // 默认返回通用技能
                    return [
                        {
                            name: '技能基础',
                            content: {
                                knowledge: ['专业技能基础', '行业知识体系', '实际项目经验'],
                                interview: ['专业能力面试题', '工作经验分享', '问题解决能力'],
                                books: ['行业相关书籍推荐'],
                                certificates: ['职业认证推荐'],
                                courses: ['在线学习课程']
                            }
                        }
                    ];
                };
                
                // 添加技能分类方法
                ui.addSkillCategory = function(skillName, contentData) {
                    if (!this.skillsContainer) return;
                    
                    const skillDiv = document.createElement('div');
                    skillDiv.className = 'skill-category';
                    skillDiv.innerHTML = `
                        <div class="skill-header" onclick="this.parentElement.classList.toggle('collapsed')">
                            <h3 class="skill-title">
                                <i class="fas fa-code"></i>
                                ${skillName}
                            </h3>
                            <i class="fas fa-chevron-down skill-toggle"></i>
                        </div>
                        <div class="skill-content">
                            <div class="content-types"></div>
                        </div>
                    `;
                    
                    const contentTypesDiv = skillDiv.querySelector('.content-types');
                    
                    // 添加各类型内容
                    this.selectedContentTypes.forEach(type => {
                        if (contentData[type]) {
                            const typeDiv = document.createElement('div');
                            typeDiv.className = 'content-type';
                            typeDiv.innerHTML = `
                                <div class="content-type-header">
                                    <i class="${this.getContentTypeIcon(type)}"></i>
                                    ${this.getContentTypeName(type)}
                                </div>
                                <div class="content-type-body">
                                    ${this.renderContentItems(contentData[type])}
                                </div>
                            `;
                            contentTypesDiv.appendChild(typeDiv);
                        }
                    });
                    
                    this.skillsContainer.appendChild(skillDiv);
                };
                
                // 添加思维导图生成方法
                ui.generateMindmapForJob = function(jobTitle, skills) {
                    if (!this.mindmapContent) return;
                    
                    // 生成 Markdown 内容
                    let markdownContent = `# ${jobTitle} 学习路线\n\n`;
                    
                    skills.forEach(skill => {
                        markdownContent += `## ${skill.name}\n\n`;
                        
                        this.selectedContentTypes.forEach(type => {
                            if (skill.content[type]) {
                                markdownContent += `### ${this.getContentTypeName(type)}\n`;
                                skill.content[type].forEach(item => {
                                    markdownContent += `- ${item}\n`;
                                });
                                markdownContent += '\n';
                            }
                        });
                    });
                    
                    // 显示思维导图
                    this.mindmapContent.innerHTML = `
                        <div class="mindmap-container">
                            <div class="mindmap-fallback">
                                <h3>${jobTitle} 学习思维导图</h3>
                                <div class="mindmap-tree">
                                    ${this.convertMarkdownToTree(markdownContent)}
                                </div>
                                <div class="mindmap-info">
                                    <p><strong>🧠 思维导图功能说明：</strong></p>
                                    <ul>
                                        <li>• 基于 ModelScope Markmap MCP 服务器生成</li>
                                        <li>• 将 Markdown 内容转换为可视化思维导图</li>
                                        <li>• 支持交互式展开、折叠、缩放功能</li>
                                        <li>• 帮助理解学习结构和知识关联</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 更新思维导图状态
                    const mindmapStatus = document.getElementById('mindmapStatus');
                    if (mindmapStatus) {
                        mindmapStatus.textContent = '完成';
                        mindmapStatus.className = 'card-status completed';
                    }
                };
                
                // 添加 Markdown 转树形结构方法
                ui.convertMarkdownToTree = function(markdown) {
                    const lines = markdown.split('\n').filter(line => line.trim());
                    let html = '<div class="mindmap-tree">';
                    let currentLevel = 0;
                    
                    lines.forEach(line => {
                        const level = (line.match(/^#+/) || [''])[0].length;
                        const text = line.replace(/^#+\s*/, '').trim();
                        
                        if (level > 0) {
                            const indent = (level - 1) * 20;
                            html += `<div class="mindmap-node level-${level}" style="margin-left: ${indent}px;">
                                <div class="node-text">${text}</div>
                            </div>`;
                        } else if (line.startsWith('- ')) {
                            const text = line.replace(/^-\s*/, '').trim();
                            html += `<div class="mindmap-node level-item" style="margin-left: 40px;">
                                <div class="node-text">• ${text}</div>
                            </div>`;
                        }
                    });
                    
                    html += '</div>';
                    return html;
                };
                
                // 添加内容类型图标和名称方法
                ui.getContentTypeIcon = function(type) {
                    const icons = {
                        knowledge: 'fas fa-lightbulb',
                        interview: 'fas fa-question-circle',
                        books: 'fas fa-book',
                        certificates: 'fas fa-certificate',
                        courses: 'fas fa-graduation-cap'
                    };
                    return icons[type] || 'fas fa-file';
                };
                
                ui.getContentTypeName = function(type) {
                    const names = {
                        knowledge: '知识点',
                        interview: '高频面试题',
                        books: '推荐书籍',
                        certificates: '证书',
                        courses: '推荐课程'
                    };
                    return names[type] || '未知类型';
                };
                
                // 初始化时更新按钮状态
                setTimeout(() => {
                    ui.updateGenerateButton && ui.updateGenerateButton();
                    // 连接到服务器实时日志流
                    ui.connectToLogStream && ui.connectToLogStream();
                    
                    // 强制修复按钮状态（确保按钮可点击）
                    const jobTitle = document.getElementById('jobTitle');
                    const generateBtn = document.getElementById('generateBtn');
                    
                    if (jobTitle && generateBtn && jobTitle.value.trim().length > 0) {
                        console.log('🔧 强制修复按钮状态...');
                        generateBtn.disabled = false;
                        generateBtn.style.opacity = '1';
                        generateBtn.style.cursor = 'pointer';
                        generateBtn.style.pointerEvents = 'auto';
                        console.log('✅ 按钮已强制启用');
                    }
                }, 100);
                
                console.log('✓ 职途助手补充方法已加载');
                
                // 添加测试五个独立模块的函数
                ui.testIndependentModules = function() {
                    console.log('🗺️ 测试五个独立模块展示');
                    
                    // 设置测试职位信息
                    this.currentJobInfo = { content: '后端工程师' };
                    
                    // 显示结果区域
                    if (this.resultsSection) {
                        this.resultsSection.style.display = 'block';
                    }
                    
                    // 更新职位显示
                    if (this.topicDisplay) {
                        this.topicDisplay.textContent = '后端工程师 - 测试模块';
                    }
                    
                    // 更新生成时间
                    if (this.generationTime) {
                        this.generationTime.textContent = new Date().toLocaleString();
                    }
                    
                    // 1. 测试知识点模块
                    this.displayStreamKnowledge([
                        '后端工程师基础理论与概念',
                        '行业最佳实践和标准',
                        '相关工具和技术栈',
                        '实际项目应用案例'
                    ]);
                    
                    // 2. 测试面试题模块
                    this.displayStreamExercises([
                        '请介绍您对后端工程师岗位的理解',
                        '您在后端开发方面有哪些实战经验？',
                        '如何设计一个高并发的后端系统？',
                        '描述一个复杂的数据库优化项目',
                        '您对微服务架构有什么理解？',
                        '如何处理分布式系统中的事务？'
                    ]);
                    
                    // 3. 测试书籍模块
                    this.displayStreamNotes({
                        keyPoints: [
                            '《机器学习实战》 - 周志华',
                            '《深度学习》 - Ian Goodfellow',
                            '《Python机器学习》 - Sebastian Raschka',
                            '《统计学习方法》 - 李航'
                        ]
                    });
                    
                    // 4. 测试课程模块
                    this.displayStreamCourses([
                        {
                            title: '机器学习入门与实战',
                            platform: 'Coursera',
                            difficulty: '初级',
                            rating: '4.8',
                            students: '50,000+',
                            description: '由斯坦福大学提供的机器学习经典课程'
                        },
                        {
                            title: '深度学习与神经网络',
                            platform: 'Udemy',
                            difficulty: '中级',
                            rating: '4.6',
                            students: '25,000+',
                            description: '从基础到高级的深度学习实战课程'
                        }
                    ]);
                    
                    // 5. 测试证书模块
                    this.displayStreamCertificates([
                        {
                            name: 'TensorFlow开发者认证',
                            provider: 'Google',
                            difficulty: '中级',
                            duration: '3-6个月',
                            value: '谷歌官方认证，行业权威性高'
                        },
                        {
                            name: 'AWS机器学习专家认证',
                            provider: 'Amazon',
                            difficulty: '高级',
                            duration: '6-12个月',
                            value: '云平台ML领域顶级认证'
                        }
                    ]);
                    
                    this.addLog && this.addLog('success', '✅ 五个独立模块测试完成');
                    console.log('✅ 五个独立模块测试完成');
                };
                
                // 添加直接的输入监听器（备用方案）
                const jobTitleInput = document.getElementById('jobTitle');
                const generateButton = document.getElementById('generateBtn');
                const testModulesBtn = document.getElementById('testModulesBtn');
                
                // 绑定测试模块按钮
                if (testModulesBtn) {
                    testModulesBtn.addEventListener('click', () => {
                        console.log('🗺️ 点击测试模块按钮');
                        ui.testIndependentModules();
                    });
                }
                
                if (jobTitleInput && generateButton) {
                    jobTitleInput.addEventListener('input', function() {
                        const hasValue = this.value.trim().length > 0;
                        console.log('📝 输入变化，更新按钮:', hasValue);
                        
                        generateButton.disabled = !hasValue;
                        generateButton.style.opacity = hasValue ? '1' : '0.6';
                        generateButton.style.cursor = hasValue ? 'pointer' : 'not-allowed';
                    });
                    
                    // 立即检查初始状态
                    const hasInitialValue = jobTitleInput.value.trim().length > 0;
                    if (hasInitialValue) {
                        generateButton.disabled = false;
                        generateButton.style.opacity = '1';
                        generateButton.style.cursor = 'pointer';
                        console.log('✅ 初始检查：按钮已启用');
                    }
                    }
                }
        
        // 添加日志流连接功能到 UI 实例
        function initializeLogStream() {
            // 检查是否已经初始化
            if (window._logStreamSetup) {
                return;
            }
            window._logStreamSetup = true;
            
            let initAttempts = 0;
            const maxAttempts = 10;
            
            function tryInit() {
                initAttempts++;
                if (initAttempts > maxAttempts) {
                    console.log('📋 已达到最大初始化尝试次数');
                    return;
                }
                
                // 等待主类加载完成
                if (window.jobAssistantUI && window.jobAssistantUI.connectToLogStream) {
                    console.log('✅ 找到 jobAssistantUI，启动日志流连接...');
                    
                    // 直接调用已有的连接方法
                    try {
                        window.jobAssistantUI.connectToLogStream();
                        console.log('✓ 实时日志流功能已集成');
                        return;
                    } catch (error) {
                        console.error('❌ 日志流连接错误:', error);
                    }
                }
                
                // 只在未成功时才重试，并且逐渐增加间隔
                const retryDelay = Math.min(500 * initAttempts, 3000);
                setTimeout(tryInit, retryDelay);
            }
            
            // 在页面加载完成后尝试初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(tryInit, 500);
                });
            } else {
                setTimeout(tryInit, 500);
            }
        }
        
        // 启动初始化
        initializeLogStream();
        
    </script>
    
    <!-- 按钮修复脚本 -->
    <script src="fix-button.js"></script>
</body>
</html>